<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Formulaire de réception des colis</title>
    <link rel="stylesheet" href="./css/index.css">
    <link rel="manifest" href="/remote_colis/manifest.json">

    <!-- External Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/pouchdb@7.3.1/dist/pouchdb.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/js-yaml/4.1.0/js-yaml.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.0.0/dist/signature_pad.umd.min.js"></script>
    <script src="./js/emailJSlight.js"></script>
</head>
<body>
    <div class="header-content">
        <img src="./img/logo.png" alt="Logo" class="logo">
        <h1>Formulaire de remise des colis</h1>
    </div>
    
    <main>
        <section>
            <form id="packageForm">
                <!-- Champ de saisie du nom du destinataire -->
                <label for="recipientName">Nom du destinataire :</label>
                <input type="text" id="recipientName" name="recipientName" required>

                <!-- Champ de saisie du nom du réceptionnaire -->
                <label for="receiverName">Nom du réceptionnaire :</label>
                <input type="text" id="receiverName" name="receiverName" required>

                <!-- Champ de saisie du nombre de colis -->
                <label for="packageCount">Nombre de colis :</label>
                <input type="number" id="packageCount" name="packageCount" min="1" required>

                <!-- Liste d'e-mails référents par service -->
                <div class="email-list">
                    <label for="serviceEmails">Emails Référents par service si colis non remis :</label>
                    <select id="serviceEmails">
                        <option value="" disabled selected>Sélectionnez un email</option>
                        <optgroup label="Test Seb">
                            <option value="sebastien.pokorski@estrepublicain.fr">sebastien.pokorski@estrepublicain.fr</option>
                        </optgroup>
                        <optgroup label="Publicité Ebra Médias">
                            <option value="charline.visca@ebramedia.fr">charline.visca@ebramedia.fr</option>
                        </optgroup>
                        <optgroup label="Rédaction">
                            <option value="sandrine.florentin@estrepublicain.fr">sandrine.florentin@estrepublicain.fr</option>
                        </optgroup>
                        <optgroup label="Ventes">
                            <option value="celia.dubois@estrepublicain.fr">celia.dubois@estrepublicain.fr</option>
                        </optgroup>
                        <optgroup label="Ebra Services">
                            <option value="myriam.lefebvre@ebraservices.fr">myriam.lefebvre@ebraservices.fr</option>
                        </optgroup>
                    </select>
                </div>

                <!-- Champ de sélection de la date et de l'heure de réception -->
                <label for="deliveryDate">Date et Heure de réception :</label>
                <input type="datetime-local" id="deliveryDate" name="deliveryDate" required>

                <!-- Champ de téléchargement de photo -->
                <label for="fileUpload">Prendre une photo :</label>
                <input type="file" id="fileUpload" accept="image/*" capture="camera">
                <div id="imagePreview"></div>

                <!-- Section de saisie de la signature -->
                <label>Signature :</label>
                <canvas id="signaturePad" width="500" height="200" style="border: 1px solid #000;"></canvas>
                <button type="button" id="clearSignature">Effacer la signature</button>

                <!-- Boutons de confirmation de livraison du colis -->
                <label>Colis Livré :</label>
                <input type="radio" id="trueRadio" name="delivered" value="true" required> Oui
                <input type="radio" id="falseRadio" name="delivered" value="false"> Non

                <button type="submit" id="saveDataBtn">Sauvegarder</button>
                <button type="button" id="clearForm">Vider les champs</button>
                <a href="admin_interface.html" id="viewResultsLink">Voir les résultats</a>
            </form>
        </section>
    </main>

    <footer>
        <p>&copy; 2024 Gestion des Colis</p>
    </footer>

    <script>
        // Enregistrement du Service Worker
        if ("serviceWorker" in navigator) {
            window.addEventListener("load", () => {
                navigator.serviceWorker
                    .register("/remote_colis/js/service-worker.js")
                    .then((registration) => {
                        console.log("Service Worker enregistré avec succès:", registration);
                    })
                    .catch((error) => {
                        console.error("Erreur d'enregistrement du Service Worker:", error);
                    });
            });
        }

        // Initialisation des bases de données locales et distantes
        const localDB = new PouchDB('receptions');
        const remoteDB = new PouchDB('remote_db_url');
        const signaturePad = new SignaturePad(document.getElementById("signaturePad"));

        const imageFiles = [];

        // Gestion de l'upload des images
        document.getElementById("fileUpload").addEventListener("change", handleImageUpload);

        // Effacement de la signature
        document.getElementById("clearSignature").addEventListener("click", () => signaturePad.clear());

        // Remise à zéro du formulaire
        document.getElementById("clearForm").addEventListener("click", clearForm);

        // Soumission du formulaire
        document.getElementById("packageForm").addEventListener("submit", submitForm);

        // Fonction de gestion du téléchargement des images
        function handleImageUpload() {
            const file = this.files[0];
            if (file && imageFiles.length < 3) {
                const reader = new FileReader();
                reader.onload = () => {
                    const img = document.createElement("img");
                    img.src = reader.result;
                    document.getElementById("imagePreview").appendChild(img);
                };
                reader.readAsDataURL(file);
                imageFiles.push(file);
            } else {
                alert("Vous ne pouvez télécharger que 3 photos au maximum.");
            }
        }

        // Fonction de remise à zéro du formulaire
        function clearForm() {
            document.getElementById("packageForm").reset();
            document.getElementById("imagePreview").innerHTML = "";
            imageFiles.length = 0;
            signaturePad.clear();
        }
    </script>
</body>
</html>
