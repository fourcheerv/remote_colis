<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Formulaire de réception des colis</title>
    <link rel="stylesheet" href="index.css">
    <script src="https://cdn.jsdelivr.net/npm/pouchdb@7.3.1/dist/pouchdb.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/js-yaml/4.1.0/js-yaml.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.0.0/dist/signature_pad.umd.min.js"></script>
</head>
<body>
    <div class="header-content">
        <img src="logo.png" alt="Logo" class="logo">
        <h1>Formulaire de remise des colis</h1>
    </div>
    <main>
        <section>
            <form id="packageForm">
                <label for="recipientName">Nom du destinataire :</label>
                <input type="text" id="recipientName" name="recipientName" required>

                <label for="receiverName">Nom du réceptionnaire :</label>
                <input type="text" id="receiverName" name="receiverName" required>

                <label for="packageCount">Nombre de colis :</label>
                <input type="number" id="packageCount" name="packageCount" min="1" required>

                <div class="email-list">
                    <label for="serviceEmails">Emails Référents par service :</label>
                    <select id="serviceEmails">
                        <optgroup label="test seb">
                            <option value="spokorski@gmail.com">spokorski@gmail.com</option>
                        </optgroup>
                        <optgroup label="Publicité Ebra Médias">
                            <option value="charline.visca@ebramedia.fr">charline.visca@ebramedia.fr</option>
                        </optgroup>
                        <optgroup label="Rédaction">
                            <option value="sandrine.florentin@estrepublicain.fr">sandrine.florentin@estrepublicain.fr</option>
                        </optgroup>
                        <optgroup label="Ventes">
                            <option value="celia.dubois@estrepublicain.fr">celia.dubois@estrepublicain.fr</option>
                        </optgroup>
                        <optgroup label="Ebra Services">
                            <option value="myriam.lefebvre@ebraservices.fr">myriam.lefebvre@ebraservices.fr</option>
                        </optgroup>
                    </select>
                </div>

                <label for="deliveryDate">Date et Heure de réception :</label>
                <input type="datetime-local" id="deliveryDate" name="deliveryDate" required>

                <label for="fileUpload">Prendre une photo :</label>
                <input type="file" id="fileUpload" accept="image/*" capture="camera">
                <div id="imagePreview"></div>

                <label>Signature :</label>
                <canvas id="signaturePad" width="500" height="200" style="border: 1px solid #000;"></canvas>
                <button type="button" id="clearSignature">Effacer la signature</button>

                <p><strong>Colis Livré :</strong></p>
                <label><input type="radio" name="delivered" value="true" required> Oui</label>
                <label><input type="radio" name="delivered" value="false"> Non</label>

                <button type="submit">Sauvegarder</button>
                <button type="button" id="clearForm">Vider les champs</button>
            </form>
        </section>
    </main>
    <footer>
        <p>&copy; 2024 Gestion des Colis</p>
    </footer>

    <script>
        // Initialisation des bases de données PouchDB
        const localDB = new PouchDB('receptions');
        const remoteDB = new PouchDB('https://apikey-v2-237azo7t1nwttyu787vl2zuxfh5ywxrddnfhcujd2nbu:b7ce3f8c0a99a10c0825a4c1ff68fe62@ca3c9329-df98-4982-a3dd-ba2b294b02ef-bluemix.cloudantnosqldb.appdomain.cloud/receptions');

        localDB.sync(remoteDB, { live: true, retry: true }).on('error', (err) => {
            console.error("Erreur de synchronisation :", err);
        });

        // Initialisation de SignaturePad
        const signaturePad = new SignaturePad(document.getElementById("signaturePad"), { backgroundColor: '#fff' });
        const imagePreview = document.getElementById("imagePreview");
        let imageFiles = [];

        // Gestion des images compressées
        document.getElementById("fileUpload").addEventListener("change", () => {
            if (imageFiles.length >= 3) {
                alert("Vous ne pouvez télécharger que 3 photos au maximum.");
                return;
            }

            const file = document.getElementById("fileUpload").files[0];
            if (file && file.type.startsWith("image/")) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = new Image();
                    img.onload = () => {
                        const canvas = document.createElement("canvas");
                        const ctx = canvas.getContext("2d");
                        canvas.width = 800;
                        canvas.height = (img.height / img.width) * 800;
                        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                        canvas.toBlob((blob) => {
                            imageFiles.push(blob);
                            const imgPreview = document.createElement("img");
                            imgPreview.src = URL.createObjectURL(blob);
                            imgPreview.style.maxWidth = "150px";
                            imgPreview.style.margin = "5px";
                            imagePreview.appendChild(imgPreview);
                        }, "image/jpeg", 0.7);
                    };
                    img.src = e.target.result;
                };
                reader.readAsDataURL(file);
            }
        });

        // Envoi d'email via Cloud Function
        async function sendEmail(data) {
            try {
                const response = await fetch("https://europe-west9-asymmetric-cove-308719.cloudfunctions.net/sendEmailFunction", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(data),
                });
                if (!response.ok) throw new Error(`Erreur HTTP ${response.status}`);
                alert("Email envoyé !");
            } catch (error) {
                console.error("Erreur d'envoi :", error);
                alert("Impossible d'envoyer l'email.");
            }
        }

        // Sauvegarde des données
        async function saveData(data) {
            try {
                await localDB.put(data);
                alert("Données sauvegardées !");
                document.getElementById("clearForm").click();
            } catch (error) {
                console.error("Erreur lors de l'enregistrement :", error);
                alert("Erreur d'enregistrement !");
            }
        }

        // Gestion du formulaire
        document.getElementById("packageForm").addEventListener("submit", async (event) => {
            event.preventDefault();

            if (imageFiles.length === 0) {
                alert("Veuillez ajouter au moins une photo avant de soumettre le formulaire !");
                return;
            }

            if (signaturePad.isEmpty()) {
                alert("Veuillez fournir une signature !");
                return;
            }

            const delivered = document.querySelector('input[name="delivered"]:checked')?.value;
            if (!delivered) {
                alert("Veuillez sélectionner si le colis est livré ou non !");
                return;
            }

            const data = {
                _id: new Date().toISOString(),
                recipientName: document.getElementById("recipientName").value,
                receiverName: document.getElementById("receiverName").value,
                packageCount: document.getElementById("packageCount").value,
                serviceEmail: document.getElementById("serviceEmails").value,
                deliveryDate: document.getElementById("deliveryDate").value,
                delivered: deliveredRadio.value, 
                signature: signaturePad.toDataURL("image/jpeg"),
                photos: imageFiles.map((file) => URL.createObjectURL(file)),
            };

            await saveData(data);

            if (delivered === "false") {
                await sendEmail({
                    toEmail: data.serviceEmail,
                    subject: "Notification : Colis non livré",
                    message: "Un colis destiné à votre service n'a pas été livré.",
                });
            }
        });

        // Réinitialisation du formulaire
        document.getElementById("clearForm").addEventListener("click", () => {
            document.getElementById("packageForm").reset();
            imagePreview.innerHTML = "";
            imageFiles = [];
            signaturePad.clear();
        });

        document.getElementById("clearSignature").addEventListener("click", () => {
            signaturePad.clear();
        });
    </script>
</body>
</html>
